{% extends "template.jinja2" %}
{% block head %}
    <link rel="stylesheet" type="text/css" href="/static/css/table.css"/>
{% endblock %}
{% block content %}
    <table class="table table-bordered">
        <thead class="thead-default">
            <tr>
                <th>Projects</th>
                <th>First choices</th>
                <th>Second Choices</th>
                <th>Third Choices</th>
                {% if cur_option == "finalise_choices" %}
                    <th>Manual Override</th>
                {% endif %}
            </tr>
        </thead>
        {% for project in most_recent_group.projects %}
            <tr>
                <td rowspan="{{ choices[project.id]["length"] or 1 }}">{{ project.title }} - {{ project.supervisor.name }}</td>
                {% for row in range(choices[project.id]["length"] or 1) %}
                    {% if loop.index != 1 %}
                        <tr>
                    {% endif %}
                    {% for option in (0, 1, 2) %}
                        {% set user = choices[project.id][option][row] %}
                        {% if user %}
                            <td><button type="button" class="btn btn-secondary btn-lg btn-block {{"active" if project.student_id == user.id  and cur_option == "finalise_choices"}}"
                                    name="{{ user.id }}" id="{{ project.id }}"
                                    {{ 'style="color: #ccc"' |safe if project.student_id != user.id and user.id in student_has_project }}
                                >
                                {{ user.name }} ({{ user.priority }})
                                </button>
                            </td>
                        {% else %}
                            <td></td>
                        {% endif %}
                    {% endfor %}
                    {% if loop.index == 1 and cur_option == "finalise_choices" %}
                        {% set overridden = project.student and project not in ((project.student.first_option, project.student.second_option, project.student.third_option)) %}
                        <td rowspan="{{ choices[project.id]["length"] or 1 }}">
                            <div class="btn-group">
                                <button type="button" class="form-control dropdown-toggle btn btn-secondary btn-lg btn-block {{ "active" if overridden}}" {{"name=%s"%project.student.id if project.student else ""}} data-toggle="dropdown" id="{{ project.id }}">
                                    {{ project.student.name if overridden else "Override" }} <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu" role="menu">
                                    {% for student in students %}
                                        {% if project not in (student.first_option, student.second_option, student.third_option) %}
                                            <li><a href="#" name="{{ project.id }}" id="{{ student.id }}">{{ student.name }}</a></li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </td>
                    {% endif %}
                    </tr>
                {% endfor %}
        {% endfor %}
    </table>
    {% if cur_option == "finalise_choices" %}
        <div class="col-sm-4">
            <button type="button" class="btn btn-primary btn-lg btn-block" id="assign">Assign CoGS members</button>
            <br/>
        </div>
        <div class="col-sm-4">
            <button type="button" class="btn btn-primary btn-lg btn-block" id="save">Save</button>
        </div>
    {% endif %}
{% endblock %}
{% block script %}
    {% if cur_option == "finalise_choices" %}
        <script>
            $("button").click(function() {
                if (this.id == "assign") {return};
                if (this.id == "save") {return};
                if ($(this).hasClass("active") && !$(this).hasClass("form-control")) {
                    $(this).removeClass("active");
                    this.style.color = "";
                    $("[name='"+this.name+"']").each(function(index) {
                        $(this).removeClass("active");
                        this.style.color = "";
                    });
                }
                else if (!$(this).hasClass("form-control")) {
                    update_buttons(this);
                }
            });

            $('.dropdown-menu').on('click', 'a', function() {
                var text = $(this).html();
                var id = $(this).attr("id");
                var htmlText = text + ' <span class="caret"></span>';
                dropdown = $(this).closest('.btn-group').find('.dropdown-toggle');
                $("[name='"+dropdown[0].name+"']").each(function(index) {
                    this.style.color = "";
                    if ($(this).hasClass("form-control")) {
                        this.name = ""
                        $(this).html('Override <span class="caret"></span>');
                    }
                });
                dropdown.attr("name", id);
                update_buttons(dropdown[0]);
                dropdown.attr("name", id);
                dropdown.html(htmlText);
            });

            $("#assign").click(function() {
                var checked = $.map($(".active").not("li"), function(n, i) {return [[n.id, n.name]]});
                map = checked.reduce(function(p, c) {
                    p[c[0]] = c[1];
                    return p;
                }, {});

                $.ajax({
                    type: "post",
                    data: map,
                    success: function(response) {
                        window.location.replace(response);
                    }
                });
            });

            function update_buttons(button) {
                name = button.name;
                $("[id='"+button.id+"']").each(function(index) {
                    if ($(this).hasClass("active")) {
                        $("[name='"+this.name+"']").each(function(index) {
                            $(this).removeClass("active");
                            this.style.color = "";
                            if ($(this).hasClass("form-control")) {
                                this.name = ""
                                $(this).html('Override <span class="caret"></span>');
                            }
                        });
                    }
                    $(this).removeClass("active");
                });
                $("[name='"+name+"']").not("a").each(function(index) {
                    $(this).removeClass("active");
                    this.style.color = "#ccc";
                    if ($(this).hasClass("form-control")) {
                        this.name = ""
                        this.style.color = "";
                        $(this).html('Override <span class="caret"></span>');
                    }
                });
                $(button).addClass("active");
                button.style.color = "";
                var checked = $.map($(".active").not("li"), function(n, i) {return n.id});
                var no_users = {{ students | length }};
                $("#assign").prop('disabled', checked.length !== no_users);
            }

            max_height = 0;
            $("td:not([rowspan])").each(function(index) {
                if($(this).height() > max_height) {
                    max_height = $(this).height();
                };
            });
            $("td:not([rowspan])").height(max_height);
            $("td[rowspan]").each(function(index) {
                rowspan = $(this).attr('rowspan');
                $(this).children().first().height(max_height * rowspan);
            });


            $("#save").click(function() {
                var checked = $.map($(".active").not("li"), function(n, i) {return [[n.id, n.name]]});
                map = checked.reduce(function(p, c) {
                    p[c[0]] = c[1];
                    return p;
                }, {});

                $.ajax({
                    type: "post",
                    data: map,
                    success: function(response) {
                        location.reload(true);
                    }
                });
            });


            $(document).ready(function() {
                {% for project in projects %}
                    {% if project.student_id %}
                        {% if project not in (user.first_option, user.second_option, user.third_option) %}
                            button = $("button[id='{{ project.id }}']:not([name])");
                            button.addClass("active");
                            button.html("{{ project.student.name }} <span class='caret'></span>");
                            button.attr("name", {{ project.student_id }});
                        {% endif %}
                    {% endif %}
                {% endfor %}

                var checked = $.map($(".active").not("li"), function(n, i) {return n.id});
                var no_users = {{ students | length }};
                console.log(checked, no_users)
                $("#assign").prop('disabled', checked.length !== no_users);
            });

        </script>
    {% endif %}
{% endblock %}