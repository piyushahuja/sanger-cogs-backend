{% extends 'template.jinja2' %}
{% block title %}User Overview{% endblock %}
{% block head %}
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css" type="text/css"/>
    <link rel="stylesheet" type="text/css" href="/static/css/table.css"/>
{% endblock %}
{% block content %}
    <form id="edit-form" method="post">
        <table class="table table-bordered">
            <thead>
                {% for header in headers %}
                <td><span>{{ header.title().replace("_", " ") }}</span></td>
                {% endfor %}
            </thead>
            {% for user in users %}
            <tr>
                <td><input name="{{ user.id }}_name" type="text" class="form-control" id="{{ user.id }}_name" placeholder="Name" required="required" value="{{ user.name }}"/></td>
                <td><input name="{{ user.id }}_email" type="text" class="form-control" id="{{ user.id }}_email" placeholder="Email address" required="required" value="{{ user.email }}"/></td>
                <td><input name="{{ user.id }}_priority" type="number" class="form-control" id="{{ user.id }}_priority" placeholder="Student priority" required="required" value="{{ user.priority }}"/></td>
                <td>
                    <select class="multiselect" name="{{ user.id }}_user_type" id="{{ user.id }}_user_type" multiple="multiple">
                        {% for type in user_types %}
                            <option value="{{ type }}" {{"disabled='disabled'" if user == logged_in and type == "grad_office"}}>{{type.title().replace("_", " ")}}</option>
                        {% endfor %}
                    </select>
                </td>
            </tr>
            {% endfor %}
        </table>
        <div class="col-sm-4">
            <button type="submit" class="btn btn-primary btn-lg btn-block" id="assign">Update</button>
        </div>
        <div class="col-sm-4"></div>
        <div class="col-sm-4">
            <button type="button" class="btn btn-primary btn-lg btn-block" id="rm_student">Remove student access</button>
            <button type="button" class="btn btn-primary btn-lg btn-block " data-toggle="button" id="hide_users">Hide users with no roles</button>
        </div>
    </form>
{% endblock %}
{% block script %}
    <script>
        var users_created = 0
        if (!String.prototype.format) {
          String.prototype.format = function() {
            var args = arguments;
            return this.replace(/{(\d+)}/g, function(match, number) {
              return typeof args[number] != 'undefined'
                ? args[number]
                : match
              ;
            });
          };
        }

        $(document).ready(function() {
            $(".multiselect").multiselect();
            {% for user in users %}
                {% for option in user.user_type.split("|") %}
                    $("#{{ user.id }}_user_type").multiselect("select", "{{ option }}");
                {% endfor %}
            {% endfor %}
            add_create_user();
            $("#hide_users").trigger("click");
        });

        $("#hide_users").click(function() {
            state = !$("#hide_users").hasClass("active");
            $(".multiselect-container").each(function(i, obj) {
                if ($(obj).children().filter(".active").length == 0) {
                    if ($(".multiselect-container").length != i + 1) {
                        $(this).closest("tr").toggle();
                    }
                }
            });
        });

        var delayedFn, blurredFrom;

        $("*").on("focusout", "tr", function () {
            tr = this
            setTimeout(function () {
                if ($(tr).has(document.activeElement).length == 0 && tr !== document.activeElement) {
                    if ($("#hide_users").hasClass("active")) {
                        if ($(tr).find(".multiselect-container").children().filter(".active").length == 0) {
                            if ($(tr).find(".multiselect-container").length != i + 1) {
                                $(tr).hide();
                            }
                        }
                    }
                }
            }, 0);
        });

        $("#rm_student").click(function() {
            {% for user in users %}
                $("#{{ user.id }}_user_type").multiselect("deselect", "student");
            {% endfor %}
        });

        function add_create_user() {
            users_created -= 1;
            $("tbody").append('<tr><td><input name="{0}_name" type="text" class="form-control" id="{0}_name" placeholder="Name"/></td><td><input name="{0}_email" type="text" class="form-control" id="{0}_email" placeholder="Email address"/></td><td><input name="{0}_priority" type="number" class="form-control" id="{0}_priority" placeholder="Student priority"/></td><td><select class="multiselect" name="{0}_user_type" id="{0}_user_type" multiple="multiple">{% for type in user_types %}<option value="{{ type }}" checked>{{type.title().replace("_", " ")}}</option>{% endfor %}</select></td></tr>'.format(users_created));
            $("#" + users_created +"_user_type").multiselect();
            $($("tbody").children().slice(-1)[0]).focusin(function() {
                $($("tbody").children().slice(-1)[0]).unbind("focusin");
                $($("tbody").children().slice(-1)[0]).find("input[type='number']").val(0)
                add_create_user();
            });
        }
    </script>
{% endblock %}
