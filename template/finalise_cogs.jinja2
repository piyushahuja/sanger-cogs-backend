{% extends "template.jinja2" %}
{% block head %}
    <link rel="stylesheet" type="text/css" href="/static/css/table.css"/>
{% endblock %}
{% block content %}
    <table class="table table-bordered table-sm">
        <thead class="thead-default">
            <tr>
                <th class="col-xs-3">Projects</th>
                <th class="col-xs-1">Wetlab</th>
                <th class="col-xs-1">Compute</th>
                <th class="col-xs-2">Student</th>
                <th class="col-xs-2">Programmes</th>
                <th class="col-xs-2">CoGS Member</th>
            </tr>
        </thead>
        {% for project in projects %}
            <tr>
                <td>{{ project.title }}</td>
                <td><span class="glyphicon {{"glyphicon-ok" if project.is_wetlab else "glyphicon-remove" }}" aria-hidden="true"></span></td>
                <td><span class="glyphicon {{"glyphicon-ok" if project.is_computational else "glyphicon-remove" }}" aria-hidden="true"></span></td>
                <td>{{ project.student.name }}</td>
                <td>{% if project.programmes %}{{ project.programmes.replace("|", "<br>") }}{% endif %}</td>
                <td>
                    <div class="btn-group">
                        <button type="button" class="form-control btn btn-default dropdown-toggle" data-toggle="dropdown" id="{{ project.id }}">
                            None <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                            {% for cogs_user in cogs_members %}
                                <li><a href="#" name="{{ project.id }}" id="{{ cogs_user.id }}">{{ cogs_user.name }}</a></li>
                            {% endfor %}
                            <li class="divider"></li>
                            <li><a href="#" name="{{ project.id }}" id="-1">None</a></li>
                        </ul>
                    </div>
                </td>
            </tr>
        {% endfor %}
    </table>

    {% if show_back %}
        <div class="col-md-4">
            <button type="button" class="btn btn-primary btn-lg btn-block" id="back">Back</button>
        </div>
        <div class="col-md-4"></div>
    {% endif %}
    <div class="col-md-4">
        <button type="button" class="btn btn-primary btn-lg btn-block" id="finish">Finish</button>
    </div>


    <div id="confirm" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Confirm Submission</h4>
                </div>
                <div class="modal-body">
                    <p>By continuing you will set the projects students are assigned. This will be irreversible. You will be able to reassign CoGS members at a later date however.</p>
                    <p>Do you want to proceed?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <a id="add" class="btn btn-success btn-ok">Submit</a>
                </div>
            </div>
        </div>
    </div>

{% endblock %}
{% block script %}
<script>

    $(".dropdown-menu a").on('click', function(){
        $('.selected[name="'+this.name+'"]').removeClass("selected");
        $(this).addClass("selected");
        $(this).parent().parent().prev().html($(this).html() + '<span class="caret"></span>');
    });

    function post(method) {
        var selected = $.map($(".selected"), function(n, i) {return [[n.name, n.id]]});
        map = selected.reduce(function(p, c) {
            p[c[0]] = c[1];
            return p;
        }, {});
        $.ajax({
            type: method,
            data: map,
            success: function(response) {
                window.location.replace(response);
            }
        });
    };

    {% if show_back %}
        $("#finish").on('click', function(){
            $('#confirm').modal({
                      backdrop: 'static',
                      keyboard: false
                    }).one('click', '#add', function() {post("post")});
        });
        $("#back").on('click', function() {post("put")});
    {% else %}
        $("#finish").on('click', function() {post("post")});
    {% endif %}

    $(document).ready(function() {
        {% for project in projects %}
            {% if project.cogs_marker %}
               $("a[name={{ project.id }}][id={{ project.cogs_marker.id }}]")[0].click();
            {% endif %}
        {% endfor %}
    });
</script>
{% endblock %}